---
# file: roles/webserver/tasks/main.yml
#
# Installs nginx with reverse proxy of '/' to {{ appserver }}
# /static is served from {{ staticpath }}
# Syncs localhost:{{ static_dir }} to {{ staticpath }}
# 

- name: Create webapps group
  group: name={{ webapp_group }} system=yes

- name: Create webapps user
  user: name={{ webapp_user }} group={{ webapp_group }} system=yes
    shell=/bin/bash home={{ webapp_home }}

- name: Add the ssh key
  authorized_key: user="{{ webapp_user }}"
    key="{{ lookup('file', 'authorized_keys') }}"

- name: Create the static directory
  sudo_user: "{{ webapp_user }}"
  file: path="{{ staticpath }}" state=directory

- name: push the static directory
  sudo: false
  remote_user: "{{ webapp_user }}"
  synchronize: src="{{ local.static_dir }}/" dest="{{ staticpath }}"

- name: Ensure nginx is installed
  apt: name=nginx

- name: Make sure nginx is running
  service: name=nginx state=started

- name: Disable the default host
  file: path=/etc/nginx/sites-enabled/default state=absent
  register: ngconf1

- name: Copy the host configuration mysite
  template: src=mysite dest=/etc/nginx/sites-available/
  register: ngconf2

- name: enable host mysite
  file: path=/etc/nginx/sites-enabled/mysite state=link 
    src=../sites-available/mysite
  register: ngconf3

- name: restart ngingx
  service: name=nginx state=restarted
  when: ngconf1.changed or ngconf2.changed or ngconf3.changed
