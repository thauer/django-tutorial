---
# file: roles/webserver/tasks/main.yml

- name: Create webapps group
  group: name={{ group }} system=yes

- name: Create webapps user
  user: name={{ user }} group={{ group }} system=yes
    shell=/bin/bash home=/webapps

- name: Add the ssh key
  authorized_key: user={{ user }}
    key="{{ lookup('file', 'authorized_keys') }}"

- name: push the static directory
  sudo: false
  remote_user: "{{ user }}"
  synchronize: src="{{project_dir}}/static" 
    dest="/webapps/django-tutorial/"

- name: Ensure nginx is installed
  apt: name=nginx

- name: Disable the default host
  file: path=/etc/nginx/sites-enabled/default state=absent
  register: ngconf1

- name: Copy the host configuration mysite
  template: src=mysite dest=/etc/nginx/sites-available/
  register: ngconf2

- name: enable host mysite
  file: path=/etc/nginx/sites-enabled/mysite state=link 
    src=../sites-available/mysite
  register: ngconf3

- name: restart ngingx
  service: name=nginx state=restarted
  when: ngconf1.changed or ngconf2.changed or ngconf3.changed
